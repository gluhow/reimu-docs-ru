# Назначение программы

@TEMPLATE=INTRO@ для проведения действий с модулем на основе процессора Эльбрус-8С или Эльбрус-8СВ (далее «платформа»). При этом платформа может быть выключена, достаточно подключить к ней STANDBY-питание.

ПО REIMU может устанавливаться как на интегрированный в материнскую плату менеджер AST2400 (в будущем планируется поддержка AST2500), так и на модуль МУС-А, вставляемый в специализированный разъём на материнской плате платформы.

ПО REIMU предоставляет следующий функционал:

* Удаленная работа по сети (протокол SSH).
* Включение, выключение и перезагрузка платформы.
* Подключение к последовательному порту платформы (Serial-over-LAN).
* Логирование данных последовательного порта.
* Работа с I²C-устройствами (сенсорами) платформы.
* Отслеживание и индикация состояния перегрева процессоров.
* Отслеживание и установка состояния UID.
* Перепрошивка программы начального старта платформы.

# Условия выполнения программы

Минимальные системные требования для установки ПО REIMU:

* Используемая ИС типа «система на чипе»: Aspeed AST2400.
* Постоянная память: не менее 32 МБ NOR Flash ROM (рекомендуется: не менее 64 МБ).
* Оперативная память: не менее 128 МБ (рекомендуется: не менее 256 МБ).

Перед установкой МУС-А в материнскую плату следует убедиться, что все ключи микропереключателя МУС-А стоят в неактивном положении (off).

После подключения STANDBY-питания к платформе её не рекомендуется включать вручную до полной загрузки менеджера (в случае такого включения платформа будет находиться под сбросом до момента готовности менеджера). Процесс загрузки индицируется соответствующим светодиодом (при его наличии) и состоит из следующих этапов:

* Инициализация аппаратуры AST2400 (примерно 2 секунды, светодиод не горит).
* Инициализация U-Boot (примерно 24 секунды, светодиод горит).
* Инициализация ядра ОС и ПО REIMU (примерно 37 секунд, светодиод мигает).
* Окончание загрузки (менеджер готов к работе, светодиод гаснет).

Полный процесс загрузки занимает примерно одну минуту. При загрузке U-Boot производится вывод в консоль UART5 (`ttyS4`) менеджера, при последующих этапах – в основную консоль, которой на различных платах могут являться либо UART2 (`ttyS1`), либо также UART5 (`ttyS4`). По окончании загрузки на всех консолях появляется приглашение ко входу в систему (также менеджер становится доступен по протоколу SSH через его сетевые интерфейсы) и загорается светодиод готовности менеджера (сигнал `ACTIVE#`) при его наличии.

# Выполнение программы и сообщения оператору

## Работа с ПО REIMU

Работа с ПО REIMU осуществляется по последовательному порту (обычно выведен на штыревой или поверхностно-контактный соединитель платформы, помеченный как MNGR CONSOLE, BMC SP или подобным образом), или по локальной сети (один или два интерфейса LAN 10/100 выведены на соединители задней панели платформы).

Параметры подключения к последовательной консоли:

* Скорость: 115200 бит/с.
* Биты данных: 8.
* Стоп-биты: 1.
* Чётность: нет.
* Контроль потока: аппаратный отсутствует, программный отсутствует.
* Кодировка: UTF-8.

Начальные IP-и MAC-адреса интерфейсов:

* Ethernet 0: IP `192.168.1.1` (префикс 24), MAC 0: `98:A7:B0:00:00:01`.
* Ethernet 1: IP `192.168.2.1` (префикс 24), MAC 1: `98:A7:B0:00:00:02`.

Можно подключиться к менеджеру по данным адресам, создав локальную сеть.

Для первоначального входа надо ввести логин «`root`» и пароль «`0penBmc`» (без кавычек, с учётом регистра, пароль начинается с цифры «ноль»).

## Первоначальная настройка REIMU

Смена пароля производится по аналогии с GNU/Linux, командой [`passwd`](https://www.opennet.ru/man.shtml?topic=passwd&category=1).

Настройки профиля пользователей (например, переменные для задания прокси-сервера и т. п.) могут быть заданы с помощью файлов в каталоге `/etc/profile.d/`. Файлы должны иметь расширение `.sh`. По умолчанию там есть файл `00-exportvars.sh`, в котором экспортируются переменные `LANG`, `TERM` и `BASH` (для более корректной работы `mc`).

Смена настроек сети (IP- и MAC-адресов и шлюза по умолчанию) производится редактированием файлов `/etc/systemd/network/00-bmc-eth?.network` (на место знака вопроса следует подставить номер необходимого интерфейса). Синтаксис этих файлов описан в [руководстве по systemd-networkd](https://wiki.archlinux.org/index.php/Systemd-networkd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)).

Поддерживается получение настроек по DHCP; для этого содержимое секций `[Network]` и `[DHCP]` соответствующего файла должно выглядеть примерно так (детали зависят от настройки DHCP-сервера в сети):

    [Network]
    DHCP=yes
    [DHCP]
    ClientIdentifier=mac
    UseDNS=yes
    UseDomains=yes

Если настройка какого-нибудь интерфейса не требуется (например, `eth1` на многих платах просто не выведен, и его настраивать смысла нет), то его нужно обозначить как unmanaged. Файл настройки в таком случае будет выглядеть как-то так (для примера, показан интерфейс `eth1`):

    [Match]
    Name=eth1
    [Link]
    Unmanaged=yes

Для авторизации пользователей возможно использовать LDAP (начиная с коммита `f664642ea`). Для этого необходимо скопировать в файловую систему менеджера правильно сконфигурированные файлы `/etc/openldap/ldap.conf`, `/etc/nslcd.conf` и отредактировать нужным образом файл `/etc/nsswitch.conf`. Возможно подключение файловых систем через AutoFS с поддержкой NFS и LDAP; данный функционал настраивается посредством редактирования файла `/etc/auto.master`.

Изменения файловой системы сохраняются между перезагрузками благодаря механизму [OverlayFS](https://en.wikipedia.org/wiki/OverlayFS), при этом размеры разделов составляют (соответственно на ПЗУ размером 32 и 64 МБ):

* Данные только для чтения: 24 или 56 МБ (путь к слою: `/run/initramfs/ro`).
* Данные для чтения и записи: 4 или 8 МБ (путь к слою: `/run/initramfs/rw`).

Рекомендуется настроить время при первом включении менеджера командой `date` (согласно [руководству по её использованию](https://www.opennet.ru/man.shtml?topic=date&category=1)). Чтобы оно не сбрасывалось при перезагрузке, необходимо сохранить его в часах реального времени менеджера командой `hwclock --systohc`.

Техническая возможность не сбрасывать время при выключении питания менеджера (т. е. STANDBY-питания платформы) на данный момент не предусмотрена.

Корневой каталог пользователя `root` настроен на путь `/home/root`. Если необходимо перенести его в другой каталог (например, если `/home` является точкой монтирования AutoFS), то нужно отредактировать соответствующим образом файл `/etc/profile`, или создать в новом домашнем каталоге файл `.profile` (если его там нет), в который добавить строчку:

    export PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin

Это позволит пользователю `root` использовать исполняемые файлы из указанных каталогов.

## SSH-консоли и COM-over-IP

Подключение к REIMU по сети с удаленной машины осуществляется по протоколу SSH на порт 22. При первом заходе на несконфигурированный менеджер возможно длительное ожидание (порядка 2-3 минут), поскольку в это время будут создаваться SSH-ключи хоста.

С удалённой машины также реализована возможность подключиться сразу к последовательному порту платформы (по умолчанию SSH на порт 2022). При этом будет произведено подключение к мультиплексору терминалов tmux, внутри которого запущен minicom, настроенный на работу с портом UART1 (`ttyS0`) менеджера, который на материнской плате соединён с портом `ttyS1` платформы.

Для того, чтобы через последовательную консоль, предоставляемую REIMU, можно было войти в сеанс командной строки платформы, на ОС Эльбрус необходимо убедиться, что в файле `/etc/inittab` присутствует строчка вида:

    s1:2345:respawn:/sbin/agetty -L ttyS1 115200

Если её там нет, то нужно добавить её в конец файла и перезагрузить платформу.

На ОС, использующих systemd (ОС Эльбрус-Д, Astra Linux, Alt Linux) нужно штатным образом включить юнит `serial-getty@ttyS1.service`, если он не включен.

Также, если интересует вывод ядра и `init` в процессе загрузки, то следует в файле `/boot/boot.conf` указать в качестве одного из параметров ядра `console=ttyS1,115200`. При этом больше в строке параметров ядра не должно присутствовать консолей типа `ttySx` из-за ограничений ядра Linux.

Изменить порт прямого входа на COM-порт платформы (по умолчанию: 2022) можно, изменив необходимый номер порта в трёх местах:

* в файле `/etc/ssh/sshd_config` в строке `Port 2022`;
* там же, в строке `Match LocalPort 2022`;
* в файле `/lib/systemd/system/sshd.socket` в строке `ListenStream=2022`.

При подключении по SSH (на любой из сконфигурированных портов) будет запрошен пароль пользователя. Отключиться от cессии Serial-over-LAN можно, последовательно нажав сочетание клавиш Ctrl+B, отпустив его, затем нажав D (далее такие комбинации клавиш будут указаны через пробел, например, в данном случае – «Ctrl+B D») – это команда «`detach`» мультиплексора терминалов tmux. Подключаться может одновременно неограниченное количество пользователей, все пользователи имеют доступ как на ввод, так и вывод. Размер терминала выбирается наименьший из всех подключенных сессий.

Если пользователь уже подключен к менеджеру по SSH на обычный порт, то он может получить доступ к COM-порту платформы, выполнив команду `tmux attach`. При отключении по «Ctrl+B D» он вернётся в свой шелл, откуда он выполнил указанную команду.

Локаль на всех консолях: `ru_RU.UTF-8`.

Лог данных из COM-порта платформы по умолчанию сохраняется в файле `/var/log/sol.log`, хранящемся в оперативной памяти менеджера (при перезагрузке менеджера содержимое лога теряется). Лог автоматически сбрасывается в каталог `/usr/log` по достижении объёма 1 МБ (сохраняются три последних лога). Также в этом каталоге имеется ссылка на текущий лог с именем `current` и его сжатый бэкап `current.gz`, который пересоздаётся раз в минуту.

Возможно сменить этот путь на какой-либо сетевой ресурс (например, общий каталог NFS, подключаемый механизмом AutoFS). Путь меняется в файле `/etc/sol.conf`; следует отредактировать строку «`SOL_LOGPATH="/var/log/sol.log"`», заменив в нём имя файла на нужное. Если логирование не нужно, то достаточно закомментировать эту строчку. После изменения этого файла следует перезапустить менеджер (или можно просто перезапустить сервис `tmux-logger` с помощью команд `systemctl stop tmux-logger`, затем, через пару секунд, `systemctl start tmux-logger`). При отключении или переносе лога также рекомендуется отключить сервисы systemd с названиями `logrotate-sol.service` и `logrotate-sol.timer`, поскольку ротация несуществующего более лога смысла не имеет.

Логирование (если оно включено) ведётся даже в отсутствие подключенной SSH-сессии. Временно отключить (и затем включить) логирование в сессии можно, нажав «Ctrl+A L». Файл не следует удалять (в таком случае Minicom потеряет к нему доступ); если его нужно вручную очистить, то для этого следует пользоваться командой `truncate`.

## Включение, выключение, перезагрузка платформы, работа с UID

Следующие команды SSH- или COM-консоли REIMU позволяют включать, выключать и перезагружать платформу:

* `server_reset` – перезагрузка платформы (нажатие кнопки сброса);
* `server_pwrbut_s` – включение (нажатие кнопки питания на 1 секунду);
* `server_pwrbut_h` – жёсткое выключение (нажатие кнопки питания на 5 секунд).

Возможно автоматическое включение питания платформы при подключении к ней STANDBY-питания. Для этого в файле `/etc/auto_power_on` нужно заменить строчку «`AUTO_POWER_ON=off`» на «`AUTO_POWER_ON=on`».

Работа с UID осуществляется, помимо кнопки UID, скриптом `server_uid`:

* `server_uid on` – включить индикатор UID;
* `server_uid off` – выключить индикатор UID;
* `server_uid query` – проверить состояние UID и вернуть код возврата;
* `server_uid show` – сделать то же самое и вывести состояние в консоль.

Команды `query` и `show` возвращают 0 в случае, если UID выключен, и 1 – если включён. Это полезно для использования в пользовательских скриптах.

## Определение перегрева процессоров

По умолчанию в ПО REIMU включен демон `overheatd`, который использует протоколы GPIO, TinySPI (при наличии ПЛИС, реализующей этот протокол, на платформе; описание данного протокола приведено в [документации на прошивку ПЛИС](http://git.lab.sun.mcst.ru/molchan_i/e8c_cpld_firmware/blob/master/docs/TinySPI_description.doc)) и I²C для определения событий перегрева процессоров. В случае допустимого перегрева процессоров (температура как минимум одного ядра присутствующего в платформе процессора выше установленного лимита, по умолчанию +85 ºC) начинает мигать светодиод перегрева на передней панели сервера (подключенный к разъёму «Overheat/Fan Fail» панелей фирмы Supermicro или к разъёму «Overheat» панелей фирмы «Депо»). В случае критического перегрева (выдачи процессором сигнала `TTRIP`, включая ситуацию, когда материнская плата экстренно выключила питание процессоров) данный светодиод светится постоянно.

Демон управляется стандартным образом с помощью `systemctl`.

Конфигурация демона осуществляется с помощью редактирования параметров в файле `/etc/overheatd.conf`:

| Название параметра     | Значение по умолчанию | Смысл параметра                                                                                                                   |
| :--------------------- |       :---------:     | :----------------------------------                                                                                               |
| OVERHEATD_ENABLED      |           yes         | При значении «no» демон отключен (не запускается в процессе загрузки менеджера при подключении STANDBY-питания к платформе).      |
| DEBUG                  |           off         | При значении «on» демон в процессе работы выводит отладочную информацию. Не рекомендуется изменять.                               |
| CPU_TEMP_LIMIT         |            85         | Лимит температуры (в ºC), при нагреве выше которой процессор считается находящимся в состоянии перегрева.                         |
| WAIT_USEC              |          500000       | Интервал (в мкс) между опросами состояния процессоров. Также приблизительно равен полупериоду мигания светодиода.                 |
| CPU_I2C_NUM            |            3          | Номер шины I²C, на которой находятся термодатчики процессоров.                                                                    |

Необходимое значение номера шины I²C следует узнавать в руководстве на материнскую плату или подобных источниках. Например, при работе с платой E8C-uATX/SE этот параметр должен иметь значение 3, с большинством других поддерживаемых материнских плат – 5. Допускаются значения от 0 до 13, за исключением 10, 11 и 12. Ниже приведена краткая сводка нумерации шин I²C:

|  В файле  |  На МУС-А  |  На AST2x00  |
| :-------: | :--------: | :----------: |
|     0     |     –      |     I2C1     |
|     1     |     –      |     I2C2     |
|     2     |    I2C3    |     I2C3     |
|     3     |    I2C4    |     I2C4     |
|     4     |     –      |     I2C5     |
|     5     |    I2C0    |     I2C6     |
|     6     |    I2C1    |     I2C7     |
|     7     |    I2C2    |     I2C8     |
|     8     |     –      |     I2C9     |
|     9     |     –      |     I2C10    |
|    13     |     –      |     I2C14    |

При наличии сомнений можно проверить наличие термодатчиков процессоров на всех перечисленных шинах с помощью утилиты `i2cdetect` (см. [руководство по её эксплуатации](https://linux.die.net/man/8/i2cdetect)), также входящей в состав ПО REIMU. При включенной платформе на выбранной шине (номер шины следует указывать в соответствии с первой колонкой таблицы) в режиме `-r` и/или `-q` должны присутствовать термодатчики с шестнадцатеричными адресами `20-2f` (для CPU0), `30-3f` (для CPU1), `40-4f` (для CPU2) и/или `50-5f` (для CPU3).

## Управление светодиодами, проверка состояния платформы

В состав ПО менеджера включена служебная утилита `setled`. Она предназначена для ручного управления светодиодами (например, для проверки их работоспособности или для индикации каких-либо событий в пользовательских скриптах). Справку по её использованию можно получить, запустив её с параметром `--help`:

    setled --help

Данная утилита позволяет управлять четырьмя светодиодами:

* «Alarm», «Fan Fail», «Overheat» – имеются на панели фирмы «Депо».
* «Fan Fail/Overheat» – имеется на большинстве панелей индикации фирмы Supermicro.
* «Power Fail» – имеется на некоторых панелях индикации фирмы Supermicro.
* «System Fail 1», «System Fail 2» – имеются на панелях индикации стандарта SSI EEB.

Следует отметить, что панели Supermicro и панели SSI EEB подключаются к разным разъёмам на материнской плате.

С помощью команды `checkalerts` можно просмотреть состояния сигналов питания, сброса, целостности корпуса и особых состояний (ALERT, FAULT, TCRIT, TTRIP), специфичных для материнской платы.

## Файл systemstate.xml

При работе демона `overheatd` в каталоге `/var/volatile` создаётся и постоянно обновляется файл `systemstate.xml`. Его содержимое можно просмотреть из последовательной консоли или ssh-сессии менеджера командой типа `cat /var/volatile/systemstate.xml` или открыть любым парсером xml-файлов.

Данный файл содержит блок `state` с параметром `date`, соответствующим дате последнего обновления, внутри которого находятся:

* блок `alerts`, содержащий текущее значение регистра статуса TinySPI (см. [руководство](http://git.lab.sun.mcst.ru/molchan_i/e8c_cpld_firmware/blob/master/docs/TinySPI_description.doc); только на материнских платах с CPLD) или сигналов ALERT, TCRIT и подобных, заходящих на менеджер (только на материнских платах без CPLD) в шестнадцатеричном формате;
* блок `cpus`, содержащий номера обнаруженных термодатчиков процессоров (от 2 до 5; номер 2 соответствует процессору № 0, номер 3 – процессору № 1 и т. д.);
* некоторое количество (зависит от количества обнаруженных процессоров) блоков `temperаture` с параметрами `cpu` (номер процессора) и `core` (номер ядра этого процессора), содержащих температуру этого ядра.

Данный файл позволяет автоматизированно удалённо определять параметры, относящиеся к работе платформы (к примеру, пользовательская система контроля может собирать эти данные с платформ и агрегировать их для дальнейшего анализа администратором).

Назначение битов значения `alerts`:

|  Бит  |  На платах с CPLD  |  На платах без CPLD  |
| :---: | :----------------: | :------------------: |
|   31  |  GPI[7]            |  PLT_RST#            |
|   30  |  GPI[6]            |  Всегда 0            |
|   29  |  GPI[5]            |  Всегда 0            |
|   28  |  GPI[4]            |  Всегда 0            |
|   27  |  GPI[3]            |  Всегда 0            |
|   26  |  GPI[2]            |  Всегда 0            |
|   25  |  GPI[1]            |  Всегда 0            |
|   24  |  GPI[0]            |  Всегда 0            |
|   23  |  APMDZ_LED#        |  APMDZ_LED#          |
|   22  |  GPIO_3V3_K9       |  Всегда 0            |
|   21  |  PWROK_MAIN        |  PWROK_ATX           |
|   20  |  APMDZ_ACTIVE#     |  Всегда 1            |
|   19  |  GPIO_1V8_H10      |  Всегда 0            |
|   18  |  GPIO_1V8_G10      |  Всегда 0            |
|   17  |  GPIO_1V8_F10      |  Всегда 0            |
|   16  |  GPIO_1V8_C8       |  Всегда 0            |
|   15  |  I2CM_TTRIP#       |  Всегда 1            |
|   14  |  I2CM_ALERT#       |  ALERT_CPU#          |
|   13  |  I2C3_TCRIT#       |  Всегда 1            |
|   12  |  I2C3_ALERT#       |  ALERT_CPU2#         |
|   11  |  I2C2_ALERT#       |  ALERT_PCIE#         |
|   10  |  I2C1_FAULT#       |  ALERT_FRU#          |
|    9  |  I2C1_TCRIT#       |  TCRIT_SMBUS#        |
|    8  |  I2C1_ALERT#       |  ALERT_SMBUS#        |
|    7  |  I2C0_TCRIT#       |  Всегда 1            |
|    6  |  I2C0_ALERT#       |  ALERT_MEM#          |
|    5  |  MNGR_ACTIVE#      |  Всегда 1            |
|    4  |  INTRUSION_SW#     |  INTRUSION_SW#       |
|    3  |  UID_LED           |  Всегда 0            |
|    2  |  PB_WAS_PRESSED    |  Всегда 1            |
|    1  |  WATCHDOG_ENABLED  |  Всегда 0            |
|    0  |  THERMAL_SHDN#     |  Всегда 1            |

## Работа с I²C-устройствами материнской платы

На данный момент в ПО REIMU имеется поддержка широкого спектра I²C-устройств, в их числе ADT7475, MAX31790, LM63, LM75, NCT7904, ADM1275, IR35221, LM25066, LTC2978, MAX31785, MAX34440, UCD9000, UCD9200, TMP421, W83773G, LTC4306, AT24 и другие.

Подключение I²C-устройств производится стандартным для Linux-интерфейса `sysfs` способом – через метафайл `new_device` нужной шины. Для примера, подключение EEPROM-памяти типа `24с128` с адресом `0x57` на шине 3 осуществляется подобной командой:

    echo 24c128 0x57 > /sys/bus/i2c/devices/i2c-3/new_device

После этого в файловой системе появляется подкаталог с названием типа `/sys/bus/i2c/devices/i2c-3/3-0057/`, в котором лежат метафайлы для управления выбранным устройством, а также чтения и записи данных. В частности, для рассматриваемого случая в этом каталоге будет файл `eeprom` с содержимым EEPROM-памяти. Для термодатчиков и контроллеров вентиляторов (например, устройство `lm96163`) там (внутри каталога `hwmon/hwmon?`) будут файлы для управления PWM-контроллерами (`pwm?`, `pwm?_enable`), а также данные с тахометров и температурных датчиков (`temp?_input`, `fan?_input`). Мультиплексоры шины типа LTC4306 просто создадут несколько дополнительных каталогов `/sys/bus/i2c/devices/i2c-*`, с которыми можно работать, как и с имеющимися изначально шинами.

Отключение I²C-устройств производится через метафайл `delete_device` нужной шины. Например, для приведённого примера EEPROM-памяти:

    echo 0x57 > /sys/bus/i2c/devices/i2c-3/delete_device

В последующих версиях ПО описания датчиков предполагается брать из специального файла (device tree), записанного в EEPROM/Flash на материнской плате, что упростит процедуру получения значений с них.

## Дополнительное ПО

В ПО REIMU включена утилита `rawi2ctool`. Она может применяться при отладке и выявлении проблем с шиной I²C и позволяет работать с I²C-устройствами на низком уровне с помощью команд `SEND` и `RECV`, то есть осуществлять прямое чтение/запись в I²C slave (вместо команд `WRITE` и `READ` с адресом регистра внутри I²C slave, применяемых в утилитах `i2cget` и `i2cset`). Она поддерживает три режима работы – с помощью системных вызовов `read()`/`write()`, с помощью пакетного IOCTL `I2C_RDWR` и с помощью команд SMBus (включая quick-команды, т. е. без посылки данных). Справку по её использованию можно получить, запустив её без параметров.

В ПО REIMU имеется файловый менеджер Midnight Commander версии 4.8.24. Запускается командой `mc`. Поддерживает подключение к удалённым файловым системам по протоколам FTP и SSH.

При необходимости проверить частоты CPU, AHB и PCLK можно командой `astclkinfo`.

Также в ПО REIMU имеются стандартные диагностические утилиты: `tcpdump`, `ethtool`, `htop`, `i2c-tools` и другие.

## Обновление прошивки менеджера

Обновление прошивки возможно с помощью утилиты `firmware-updater`. Справку по её использованию можно получить, запустив её с параметром `-h` или `--help`. Она позволяет прошивать менеджер либо уже скопированным на него файлом прошивки, либо скачиваемым из сети по протоколам HTTP, HTTPS, FTP или SCP.

Перед прошивкой менеджера необходимо подключиться к его последовательной консоли и перейти в однопользовательский режим командой `init 1`.  Перед этим рекомендуется выключить настройку сети по DHCP и вручную задать настройки IP-адресов, DNS-серверов и т. п., поскольку DHCP-клиент в однопользовательском режиме останавливается.

Пример запуска для скачки файла прошивки с файл-сервера (например, протокол HTTP):

    firmware-updater http://example.org/files/fimware.bin

Пример запуска для забора файла прошивки с сервера по протоколу SCP:

    firmware-updater scp://admin@example.org:/files/fimware.bin

Пример запуска для прошивки уже каким-либо образом скачанным в файловую систему менеджера файлом:

    firmware-updater file:///tmp/fimware.bin

После успешной прошивки будет автоматически произведена перезагрузка менеджера (разумеется, это приведёт и к перезагрузке платформы).

При обновлении REIMU с помощью утилиты `firmware-updater` изменения, сделанные в файловой системе для чтения и записи, будут сохранены (если это не нужно, то нужно перед ссылкой на файл прошивки указать параметр `--fullclear`). При полной перепрошивке образа с помощью программатора это невозможно, если нет возможности задать перезаписываемый объём ПЗУ (в противном случае нужно перезаписывать только первые 24 МБ или 56 МБ в зависимости от размера флеш-памяти).

Пример команды, выполняющей сброс настроек после перепрошивки:

    firmware-updater --fullclear file:///tmp/fimware.bin

При возникновении ошибок файловой системы после перепрошивки без сброса настроек (такое возможно при конфликте inode number-ов слоёв OverlayFS и подобных проблемах) рекомендуется сохранить важные файлы настроек с менеджера, перепрошить его с опцией `--fullclear`, а затем заново скопировать на него эти файлы.

При выкачивании прошивки по сети необходимо следить за тем, чтобы менеджер имел необходимый объём свободного ОЗУ размером чуть больше файла прошивки, поскольку прошивка скачивается во временный файл на RAM-диске менеджера. После прошивки этот файл удаляется. При этом исходный файл при работе по протоколу `file://` не удаляется (такой файл не считается временным: раз пользователь сам скачал файл в файловую систему менеджера, то удалять его должен также он сам).

Если файл прошивки больше по размеру, чем перепрошиваемая ПЗУ (а в случае, если не указана опция `--fullclear` и прошивается ПЗУ менеджера, то за вычетом раздела с настройками пользователя, который имеет размер 4 МБ на ПЗУ объёмом 32 МБ, и 16 МБ на ПЗУ объёмом 64 МБ), то В ПЗУ будет записана только соответствующая часть файла прошивки с его начала. Если же файл прошивки меньше, то он будет прошит полностью с начала ПЗУ; при этом непрошитые области модифицированы не будут.

Желательно, чтобы файл имел размер, кратный размеру блока ПЗУ (512 байт); если его размер отличается, то файл (при работе по протоколу, отличному от `file://`, после скачивания; в противном случае прямо на месте) будет автоматически увеличен, чтобы соответствовать данному требованию.

При использовании протоколов HTTP, HTTPS и FTP утилита реагирует на переменную окружения `WGET_PARAMS`, с помощью которой ей можно подавать какие-либо параметры для вызова `wget`, например, `--no-check-certificate`:

    WGET_PARAMS=--no-check-certificate \
    firmware-updater https://untrusted.example.org/files/firmware.bin

## Обновление программы начального старта платформы

Обновление программы начального старта (ПНС) платформы возможно с помощью программы-обёртки `update-host-flash` для утилиты `firmware-updater`.

Порядок её использования аналогичен программе `firmware-updater` за исключением того, что перезагрузка менеджера после прошивки не производится (поскольку прошивается не менеджер), и в однопользовательский режим для прошивки переходить не требуется, следовательно, прошивка ПНС может быть осуществлена из SSH-сессии (в то время как прошивка менеджера – только из сессии его последовательного порта: несмотря на то, что сеть при этом остаётся доступна, SSH-подключения в однопользовательском режиме недоступны). Как и в случае с прошивкой менеджера, можно использовать файл прошивки, меньший по размеру, чем сама ПЗУ.

Следует помнить, что на время прошивки ПНС SPI-шина с ПЗУ ПНС будет отключена от платформы (т. е. не рекомендуется производить прошивку ПНС, если платформа работает – это может привести к неопределённому её поведению).

# Перечень сокращений

AHB – Advanced High-Performance Bus

BMC – Baseboard Management Controller

CPLD – Complex Programmable Logic Device

CPU – Central Processing Unit

DHCP – Dynamic Host Configuration Protocol

DNS – Domain Name System

EEPROM – Electrically Erasable Programmable ROM

FS – File System

FTP – File Transfer Protocol

GNU – GNU is Not Unix

GPIO – General Purpose Input/Output

HTTP – Hypertext Transfer Protocol

HTTPS – Hypertext Transfer Protocol, Secure

I²C – Inter-Integrated Circuit

IOCTL – Input/Output Control

IP – Internet Protocol

LAN – Local Area Network

LDAP – Lightweight Directory Access Protocol

MAC – Media Access Control

NFS – Network File System

NOR – No-Or

PCLK – Peripheral Clock

PWM – Pulse-Width Modulation

RAM – Random Access Memory

REIMU – Remote Intelligent Management Unit

ROM – Read-Only Memory

SCP – Secure Copy

SPI – Serial Peripheral Interface

SSH – Secure Shell

SSI EEB – Server System Infrastructure Enterprise Electronics Bay

TinySPI – Tiny Serial Peripheral Interface

UART – Universal Asynchronous Receiver-Transmitter

UID – Unit Identification

UTF-8 – Unicode Transformation Format, 8-bit

ИС – интегральная схема

МН – машинный носитель

МУС-А – модуль управления системой МУС-А ЛЯЮИ.469535.149

ОЗУ – оперативное запоминающее устройство

ОС – операционная система

ПЗУ – постоянное запоминающее устройство

ПЛИС – программируемая логическая интегральная схема

ПНС – программа начального старта

ПО – программное обеспечение
