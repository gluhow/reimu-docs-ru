<!---
****************************************************************************
*                                                                          *
*  Automatically generated file. Do not edit. Edit template file instead.  *
*                                                                          *
****************************************************************************
--->
# Интеграция ПО REIMU

## Требования к аппаратному обеспечению

* Микросхема BMC - AST2400 или AST2500.
* В качестве флеш-памяти для основной прошивки должна использоваться SPI NOR-память размера 32 или 64 МБ.
* UART2 (ttyS1) или UART5 (ttyS4) менеджера должен быть доступен пользователю.
* Должна быть доступна SPI NOR-память программы начального старта платформы с помощью управляемого линией `SPI_MNGR_CONNECT` ключа (при `SPI_MNGR_CONNECT == 1` эта микросхема не должна быть подключена ни к какому другому SPI-мастеру).
* UART1 (ttyS0) менеджера должен быть соединён с платформой для обеспечения протокола Serial-on-LAN.

## Таблица назначения GPIO

Наиболее актуальная таблица назначения GPIO указана в файле `/etc/gpiotab` на BMC.

В колонке "направление" указан не электрический источник сигнала, а устройство, инициирующее передачу. Здесь BMC - это BMC, PL - платформа.

| Обозначение                 | Направление | Назначение                                | Линия GPIO |
|:--------------------------- |:-----------:|:----------------------------------------- |:----------:|
| GPIO_PWR_BTN                | BMC&rarr;PL | Кнопка POWER платформы                    |     N5     |
| GPIO_RST_BTN                | BMC&rarr;PL | Кнопка RESET платформы                    |     P3     |
| GPIO_RESET_IN               | BMC&larr;PL | Сигнал "платформа под сбросом"            |     O3     |
| GPIO_POWER_IN               | BMC&larr;PL | Сигнал "платформа под питанием"           |     O2     |
| GPIO_INTRUSION              | BMC&larr;PL | Сигнал датчика вскрытия корпуса платформы |     R0     |
| GPIO_ACT_LED                | BMC&rarr;PL | Светодиод "BMC работает"                  |     O6     |
| GPIO_BOOT_LED               | BMC&rarr;PL | Светодиод "BMC загружается"               |     G1     |
| GPIO_APMDZ_LED              | BMC&larr;PL | Сигнал от АПМДЗ платформы                 |     F3     |
| GPIO_ALERT_1                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B0     |
| GPIO_ALERT_2                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B5     |
| GPIO_ALERT_3                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B6     |
| GPIO_ALERT_4                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B2     |
| GPIO_ALERT_5                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B3     |
| GPIO_ALERT_6                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B1     |
| GPIO_ALERT_7                | BMC&larr;PL | Один из сигналов ALERT платформы          |     B7     |
| GPIO_MB_ID0                 | BMC&larr;PL | Идентификация платформы                   |     Y0     |
| GPIO_MB_ID1                 | BMC&larr;PL | Идентификация платформы                   |     Y1     |
| GPIO_MB_ID2                 | BMC&larr;PL | Идентификация платформы                   |     Y2     |
| GPIO_MB_ID3                 | BMC&larr;PL | Идентификация платформы                   |     Y3     |
| GPIO_SPI_CONNECT            | BMC&rarr;PL | Подключение SPI памяти платформы          |     O0     |
| **На платформах без CPLD:** |             |                                           |            |
| GPIO_UID_BTN                | BMC&larr;PL | Кнопка UID платформы                      |     N3     |
| GPIO_UID_LED                | BMC&rarr;PL | Светодиод UID платформы                   |     N4     |
| GPIO_SYS_FAIL1_LED          | BMC&rarr;PL | Светодиод SYS FAIL 1 платформы            |     C2     |
| GPIO_SYS_FAIL2_LED          | BMC&rarr;PL | Светодиод SYS FAIL 2 платформы            |     C7     |
| GPIO_PWR_FAIL_LED           | BMC&rarr;PL | Светодиод POWER FAIL платформы            |     A3     |
| GPIO_OH_FF1_LED             | BMC&rarr;PL | Светодиод OVERHEAT/FAN FAIL 1 платформы   |     A2     |
| GPIO_OH_FF2_LED             | BMC&rarr;PL | Светодиод OVERHEAT/FAN FAIL 2 платформы   |     Q6     |
| GPIO_FAN_FAIL_LED           | BMC&rarr;PL | Светодиод FAN FAIL платформы              |     C6     |
| GPIO_OVERHEAT_LED           | BMC&rarr;PL | Светодиод OVERHEAT платформы              |     C3     |
| GPIO_ALARM_LED              | BMC&rarr;PL | Светодиод ALARM платформы                 |     G0     |
| **На платформах c CPLD:**   |             |                                           |            |
| GPIO_UID_BTN                | BMC&rarr;PL | Кнопка UID платформы                      |     N3     |
| GPIO_UID_LED                | BMC&larr;PL | Состояние UID платформы                   |     N4     |
| GPIO_TINYSPI_CS             | BMC&rarr;PL | Канал связи с CPLD                        |     N2     |
| GPIO_TINYSPI_IO             | BMC&rarr;PL | Канал связи с CPLD                        |     N1     |
| GPIO_TINYSPI_CLK            | BMC&rarr;PL | Канал связи с CPLD                        |     N0     |
| GPIO_TINYSPI_ALERT          | BMC&larr;PL | Сигнал "CPLD изменила состояние"          |     N6     |

### Пины GPIO_MB_ID

При наличии на платформе CPLD, связанной с BMC по протоколу TinySPI, все 4 пина `GPIO_MB_ID` должны находиться в высоком уровне.

Любое другое состояние этих пинов интерпретируется как отсутствие CPLD.

## Данные, описывающие платформу

### Память программы начального старта

В ПЗУ программы начального старта должно находиться описание устройств платформы в формате flattened device tree (DTB).

В случае наличия в ПЗУ таблицы разделов device tree должно находиться в соответствующем разделе; иначе начиная с адреса 7 МБ.

В device tree должен находиться блок (node) с адресом `/bmc`, внутри которого могут находиться следующие свойства (properties) и блоки (nodes):

* свойство `compatible = "mcst,флавор";`, здесь вместо "`флавор`" надо подставить название флавора прошивки. Это свойство не используется BMC и имеет только информативное значение.
* свойство `tinyspi;` - должно быть указано для платформ с CPLD.
* свойства `i2c0`..`i2c13` (`i2c0`..`i2c15` в будущем для AST2600) - ссылки на блоки, описывающиы I²C-шины и устройства на них, доступные BMC. Некоторые из ссылок могут отсутствовать. FRU ID EEPROM, RTC и т.п. должны находиться на этих шинах.
* блоки `alert1`..`alert7` - блоки, задающие пристутствующие в платформе сигналы ALERT и их названия (в параметре `label` внутри этих блоков). Некоторые из блоков могут отсутствовать.
* блок `intrusion` - блок, задающий пристутствующий в платформе сигнал вскрытия корпуса и его полярность (в параметре `polarity` внутри этого блока: `"no"` - 0 при закрытой крышке, `"nс"` - 1 при закрытой крышке). Блок может отсутствовать.

Пример подобного описания (без описания блоков, соответствующих шинам I²C):

```
    bmc {
        compatible = "mcst,reimu-5564";

        i2c3 = &i2c_pmbus;
        i2c4 = &i2c_fruid;
        i2c5 = &i2c_mntr;
        i2c7 = &i2c_cpu;
        i2c8 = &i2c_pci;

        alert1 {
            label = "CPU overheat";
        };

        alert6 {
            label = "SMBus critical overheat";
        };

        intrusion {
            polarity = "nc";
        };
    };
```

При отстутствии такого описания или отсутствии device tree в ПЗУ программы начального старта FRUID EEPROM ищется на шине `i2c5` с адресом `0x57`.

### FRUID EEPROM

На платформе должна иметься FRU ID EEPROM (24С128 или совместимая), описанная в device tree платформы следующим образом:

```
    eeprom@57 {
        compatible = "atmel,24c128";
        reg = <0x57>;
        label = "FRUID";
    };
```

Признак, по которому определяется, что это микросхема FRU ID - это значение `"FRUID"` параметра `label`.

При отстутствии такого описания или отсутствии device tree в ПЗУ программы начального старта FRUID EEPROM ищется на шине `i2c5` с адресом `0x57`.

### RTC платформы

Для хранения времени при отключенном дежурном питании платформы на платформе должна иметься микросхема I²C RTC (MCP7940x или совместимая), описанная в device tree платформы следующим образом:

```
    mcp7940@6f {
        compatible = "microchip,mcp7940x";
        reg = <0x6f>;
        label = "platform";
    };
```

Признак, по которому определяется, что это микросхема RTC платформы - это значение `"platform"` параметра `label`.

При отстутствии такого описания или отсутствии device tree в ПЗУ программы начального старта считается, что RTC платформы отсутствует, и при включении дежурного питания время BMC устанавливается на 1 января 1970 года.

### Индикатор POST кодов

На платформе могут иметься две микросхемы GPIO-расширителей (MCP23017 или совместимые), описанные в device tree платформы следующим образом:

```
    pca9534@20 {
        compatible = "microchip,mcp23017";
        reg = <0x20>;
        label = "postcode";
    };
    pca9534@21 {
        compatible = "microchip,mcp23017";
        reg = <0x21>;
        label = "health";
    };
```

Микросхема, обозначенная как `"postcode"` в параметре `label` считается содержащей POST-коды (их туда пишет программа начального старта или ОС платформы).

Микросхема, обозначенная как `"health"` в параметре `label` считается применяемой для управления Health LED платформы.

При отстутствии такого описания или отсутствии device tree в ПЗУ программы начального старта считается, что Health LED на платформе отсутствует, а POST-коды не определены.

Назначение битов GPIO-расширителей (0 - активный уровень, 1 - неактивный):

| Бит         | Назначение                           |
| ----------- | ------------------------------------ |
| postcode:0  | Сегмент E младшего разряда POST-кода |
| postcode:1  | Сегмент D младшего разряда POST-кода |
| postcode:2  | Сегмент C младшего разряда POST-кода |
| postcode:3  | Сегмент H младшего разряда POST-кода |
| postcode:4  | Сегмент B младшего разряда POST-кода |
| postcode:5  | Сегмент A младшего разряда POST-кода |
| postcode:6  | Сегмент D младшего разряда POST-кода |
| postcode:7  | Сегмент F младшего разряда POST-кода |
| postcode:8  | Сегмент E cтаршего разряда POST-кода |
| postcode:9  | Сегмент D cтаршего разряда POST-кода |
| postcode:10 | Сегмент C cтаршего разряда POST-кода |
| postcode:11 | Сегмент H cтаршего разряда POST-кода |
| postcode:12 | Сегмент B cтаршего разряда POST-кода |
| postcode:13 | Сегмент A cтаршего разряда POST-кода |
| postcode:14 | Сегмент G cтаршего разряда POST-кода |
| postcode:15 | Сегмент F cтаршего разряда POST-кода |
| health:8    | Синий кристалл светодиода Health     |
| health:9    | Зелёный кристалл светодиода Health   |
| health:10   | Красный кристалл светодиода Health   |

Прочие биты не используются.

Расположение сегментов семисегментных индикаторов:

```
  AAAA
F      B
F      B
  GGGG
E      C
E      C
  DDDD   H

```
